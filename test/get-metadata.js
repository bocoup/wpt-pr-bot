'use strict';
var assert = require('chai').assert,
    getMetadata = require('../lib/metadata');

suite('getMetadata', function() {
    test('retrieval and formatting of metadata', function() {
        var expected = {
            issue: 11698,
            rootReviewers: [ 'jgraham' ],
            filenames: [ 'WebIDL/interfaces.html', 'interfaces/WebIDL.idl' ],
            filenamesIgnoreRemoved: [ 'WebIDL/interfaces.html', 'interfaces/WebIDL.idl' ],
            paths: [ 'WebIDL', 'interfaces' ],
            labels: [ 'WebIDL', 'interfaces', 'wg-webplatform' ],
            isRoot: false,
            isReviewable: false,
            specs: {
                WebIDL: {
                    authors: [
                        'Cameron McCormack',
                        'Boris Zbarsky',
                        'Tobie Langel'
                    ],
                    href: 'https://heycam.github.io/webidl/',
                    title: 'Web IDL',
                    status: 'ED',
                    publisher: 'W3C',
                    edDraft: 'https://heycam.github.io/webidl/',
                    deliveredBy: [
                        {
                            shortname: 'webplatform',
                            url: 'https://www.w3.org/WebPlatform/WG/'
                        }
                    ],
                    versions: [
                        'WebIDL-20161215',
                        'WebIDL-20160915',
                        'WebIDL-20160308',
                        'WebIDL-20150804',
                        'WebIDL-20120419',
                        'WebIDL-20120207',
                        'WebIDL-20110927',
                        'WebIDL-20110712',
                        'WebIDL-20101021',
                        'WebIDL-20081219',
                        'WebIDL-20080829',
                        'WebIDL-20080410',
                        'WebIDL-20071017'
                    ],
                    repository: 'https://github.com/heycam/webidl',
                    id: 'WebIDL',
                    date: '15 December 2016'
                }
            },
            workingGroups: [ 'webplatform' ],
            owners: [
               { login: 'yuki3', permission: 'write' },
               { login: 'tobie', permission: 'write' },
               { login: 'jensl', permission: 'write' },
               { login: 'domenic', permission: 'write' }
            ],
            author: { login: 'lukebjerring', permission: 'write', isOwner: false },
            reviewersExcludingAuthor: [
               { login: 'yuki3', permission: 'write' },
               { login: 'tobie', permission: 'write' },
               { login: 'jensl', permission: 'write' },
               { login: 'domenic', permission: 'write' }
            ],
            reviewers: [ 'domenic', 'jensl', 'ms2ger', 'tobie', 'yuki3' ],
            isMergeable: true,
            reviewedDownstream: false,
            missingReviewers: []
        };

        return getMetadata(11698, 'lukebjerring', '')
            .then(function(actual) {
                assert.deepEqual(expected, actual);
            });
    });

    test('limiting labels for pull requests that modify many files', function() {
        var expected = [
            '.well-known',
            '2dcontext',
            'BackgroundSync',
            'FileAPI',
            'IndexedDB',
            'WebCryptoAPI',
            'WebIDL',
            'accelerometer',
            'accname',
            'acid',
            'ambient-light',
            'annotation-model',
            'annotation-protocol',
            'annotation-vocab',
            'apng',
            'async-local-storage',
            'audio-output',
            'background-fetch',
            'battery-status',
            'beacon',
            'bluetooth',
            'budget-api',
            'clear-site-data',
            'client-hints',
            'clipboard-apis',
            'assets',
            'compat',
            'conformance-checkers',
            'console',
            'content-security-policy',
            'cookie-store',
            'cookies',
            'core-aam',
            'fetch',
            'credential-management',
            'CSS1',
            'CSS2',
            'WOFF2',
            'compositing',
            'css-align',
            'css-animations',
            'css-backgrounds',
            'css-break',
            'css-cascade',
            'css-color',
            'css-conditional',
            'css-contain',
            'css-content',
            'css-counter-styles',
            'css-display',
            'css-exclusions',
            'css-fill-stroke',
            'css-filter',
            'css-flexbox',
            'css-font-loading',
            'css-fonts',
            'css-gcpm',
            'css-grid',
            'css-images',
            'css-layout-api',
            'css-lists',
            'css-logical',
            'css-masking',
            'css-multicol',
            'css-namespaces',
            'css-overflow',
            'css-page',
            'css-paint-api',
            'css-position',
            'css-properties-values-api',
            'css-pseudo',
            'css-regions',
            'css-rhythm',
            'css-round-display',
            'css-ruby',
            'css-scoping',
            'css-scroll-anchoring',
            'css-scroll-snap',
            'css-scrollbars',
            'css-shadow-parts',
            'css-shapes',
            'css-sizing',
            'css-speech',
            'css-style-attr',
            'css-syntax',
            'css-tables',
            'css-text-decor',
            'css-text',
            'css-timing',
            'css-transforms',
            'css-transitions',
            'css-typed-om',
            'css-ui',
            'css-values',
            'css-variables',
            'css-writing-modes',
            'cssom-view',
            'cssom',
            'filter-effects',
            'geometry',
            'mediaqueries',
            'motion',
            'reference',
            'selectors',
            'support',
            'css',
            'infra',
            'vendor-imports',
            'custom-elements',
            'device-memory',
            'docs',
            'dom',
            'domparsing',
            'domxpath',
            'dpub-aam',
            'dpub-aria',
            'editing',
            'encoding',
            'encrypted-media',
            'entries-api',
            'eventsource',
            'feature-policy',
            'fullscreen',
            'gamepad',
            'generic-sensor',
            'geolocation-API',
            'geolocation-sensor',
            'graphics-aam',
            'gyroscope',
            'hr-time',
            'html-imports',
            'html-longdesc',
            'html-media-capture',
            'html',
            'wg-html',
            'wg-webplatform',
            'wg-webapps',
            'wg-webcrypto',
            'wg-das',
            'wg-annotation',
            'wg-webrtc',
            'wg-webperf',
            'wg-webappsec',
            'wg-css',
            'wg-fonts',
            'wg-svg',
            'wg-dom',
            'wg-geolocation'
        ];

        return getMetadata(11201, 'kereliuk', '')
            .then(function(actual) {
                assert.sameMembers(expected, actual.labels);
            });
    });
});
